# Vulnerability Patterns by Language/Framework

## JavaScript / Node.js

### SQL Injection
```javascript
// VULNERABLE
db.query(`SELECT * FROM users WHERE id = ${userId}`);
db.query("SELECT * FROM users WHERE id = " + userId);

// SECURE
db.query("SELECT * FROM users WHERE id = ?", [userId]);
db.query("SELECT * FROM users WHERE id = $1", [userId]);
```

### NoSQL Injection (MongoDB)
```javascript
// VULNERABLE
db.users.find({ username: req.body.username, password: req.body.password });
// Attack: { "username": "admin", "password": { "$ne": "" } }

// SECURE
const username = String(req.body.username);
const password = String(req.body.password);
db.users.find({ username, password });
```

### Command Injection
```javascript
// VULNERABLE
exec(`ls ${userInput}`);
spawn('sh', ['-c', `cat ${filename}`]);

// SECURE
execFile('ls', [userInput]); // No shell
spawn('cat', [filename], { shell: false });
```

### Prototype Pollution
```javascript
// VULNERABLE
Object.assign(target, userControlledObject);
_.merge(target, userInput);
_.defaultsDeep(target, userInput);
JSON.parse(userInput); // with __proto__

// DETECTION
grep -rn "__proto__\|constructor\[" --include="*.js"
grep -rn "\.merge\|\.assign\|\.extend\|\.defaults" --include="*.js"
```

### XSS (Cross-Site Scripting)
```javascript
// VULNERABLE - React
<div dangerouslySetInnerHTML={{ __html: userContent }} />

// VULNERABLE - DOM
element.innerHTML = userInput;
document.write(userInput);
eval(userInput);

// VULNERABLE - Template literals
res.send(`<div>${userInput}</div>`);
```

### Path Traversal
```javascript
// VULNERABLE
const filepath = path.join(__dirname, 'files', req.params.filename);
fs.readFile(`./uploads/${req.query.file}`);

// SECURE
const safePath = path.normalize(req.params.filename).replace(/^(\.\.(\/|\\|$))+/, '');
if (!safePath.startsWith(baseDir)) throw new Error('Invalid path');
```

### JWT Issues
```javascript
// VULNERABLE - Algorithm confusion
jwt.verify(token, secret, { algorithms: ['HS256', 'RS256'] });

// VULNERABLE - No verification
const decoded = jwt.decode(token); // Just decodes, no verify!

// SECURE
jwt.verify(token, publicKey, { algorithms: ['RS256'] });
```

### SSRF
```javascript
// VULNERABLE
axios.get(req.body.url);
fetch(userProvidedUrl);

// SECURE
const allowedHosts = ['api.example.com'];
const parsed = new URL(userUrl);
if (!allowedHosts.includes(parsed.hostname)) throw new Error('Blocked');
```

### Express.js Specific
```javascript
// VULNERABLE - Missing CSRF
app.post('/transfer', (req, res) => { /* no csrf check */ });

// VULNERABLE - Missing helmet
const app = express(); // No security headers

// VULNERABLE - Overly permissive CORS
app.use(cors({ origin: '*', credentials: true }));

// VULNERABLE - Body parser limit
app.use(express.json()); // No size limit - DoS risk
```

---

## Python

### SQL Injection
```python
# VULNERABLE
cursor.execute(f"SELECT * FROM users WHERE id = {user_id}")
cursor.execute("SELECT * FROM users WHERE id = " + user_id)
cursor.execute("SELECT * FROM users WHERE id = %s" % user_id)

# SECURE
cursor.execute("SELECT * FROM users WHERE id = %s", (user_id,))
cursor.execute("SELECT * FROM users WHERE id = :id", {"id": user_id})
```

### Command Injection
```python
# VULNERABLE
os.system(f"ls {user_input}")
subprocess.call(f"cat {filename}", shell=True)
eval(user_input)
exec(user_input)

# SECURE
subprocess.run(["ls", user_input], shell=False)
subprocess.run(["cat", filename], check=True)
```

### Path Traversal
```python
# VULNERABLE
open(f"./uploads/{filename}")
os.path.join(base_dir, user_input)  # Still vulnerable!

# SECURE
safe_path = os.path.normpath(os.path.join(base_dir, filename))
if not safe_path.startswith(base_dir):
    raise ValueError("Invalid path")
```

### Pickle Deserialization
```python
# VULNERABLE
pickle.loads(user_data)
pickle.load(file)
yaml.load(user_input)  # Without Loader

# SECURE
# Never unpickle untrusted data
yaml.safe_load(user_input)
```

### SSTI (Server-Side Template Injection)
```python
# VULNERABLE - Jinja2
Template(user_input).render()
render_template_string(user_input)

# VULNERABLE - Format strings
user_controlled.format(**data)
f"{user_controlled}"

# SECURE
render_template("template.html", data=user_input)
```

### Django Specific
```python
# VULNERABLE - Raw SQL
User.objects.raw(f"SELECT * FROM users WHERE id = {id}")

# VULNERABLE - Extra
User.objects.extra(where=[f"id = {id}"])

# VULNERABLE - Mass assignment
User.objects.create(**request.POST)

# SECURE
User.objects.filter(id=id)
User.objects.create(name=request.POST['name'])  # Explicit fields
```

### Flask Specific
```python
# VULNERABLE - Debug mode in production
app.run(debug=True)

# VULNERABLE - Secret key
app.secret_key = "hardcoded"

# VULNERABLE - Open redirect
return redirect(request.args.get('next'))
```

---

## Go

### SQL Injection
```go
// VULNERABLE
db.Query("SELECT * FROM users WHERE id = " + userID)
db.Query(fmt.Sprintf("SELECT * FROM users WHERE id = %s", userID))

// SECURE
db.Query("SELECT * FROM users WHERE id = $1", userID)
db.QueryRow("SELECT * FROM users WHERE id = ?", userID)
```

### Command Injection
```go
// VULNERABLE
exec.Command("sh", "-c", userInput).Run()
exec.Command("bash", "-c", "ls " + dir).Output()

// SECURE
exec.Command("ls", dir).Run()  // No shell
```

### Path Traversal
```go
// VULNERABLE
http.ServeFile(w, r, r.URL.Path)
os.Open(userInput)

// SECURE
cleanPath := filepath.Clean(userInput)
if !strings.HasPrefix(cleanPath, baseDir) {
    http.Error(w, "Invalid path", 400)
    return
}
```

### SSRF
```go
// VULNERABLE
resp, _ := http.Get(userProvidedURL)

// SECURE
parsed, _ := url.Parse(userProvidedURL)
if !isAllowedHost(parsed.Host) {
    return errors.New("blocked host")
}
```

### Race Conditions
```go
// VULNERABLE - Check-then-act
if balance >= amount {
    balance -= amount  // Race condition!
}

// SECURE
var mu sync.Mutex
mu.Lock()
defer mu.Unlock()
if balance >= amount {
    balance -= amount
}
```

---

## PHP

### SQL Injection
```php
// VULNERABLE
$query = "SELECT * FROM users WHERE id = " . $_GET['id'];
mysql_query("SELECT * FROM users WHERE id = '$id'");

// SECURE
$stmt = $pdo->prepare("SELECT * FROM users WHERE id = ?");
$stmt->execute([$id]);
```

### Command Injection
```php
// VULNERABLE
system($_GET['cmd']);
exec("ls " . $userInput);
passthru($command);
shell_exec("cat " . $file);

// SECURE
$output = shell_exec(escapeshellcmd($command));
$arg = escapeshellarg($userInput);
```

### File Inclusion (LFI/RFI)
```php
// VULNERABLE
include($_GET['page']);
require($userInput . ".php");

// SECURE
$allowed = ['home', 'about', 'contact'];
if (in_array($_GET['page'], $allowed)) {
    include($_GET['page'] . '.php');
}
```

### Object Injection
```php
// VULNERABLE
unserialize($_COOKIE['data']);
unserialize($_POST['object']);

// SECURE
json_decode($_POST['data'], true);
```

### Type Juggling
```php
// VULNERABLE
if ($password == $hash) { }  // Loose comparison
if ($_GET['admin'] == true) { }

// SECURE
if ($password === $hash) { }  // Strict comparison
if ($_GET['admin'] === 'true') { }
```

### Laravel Specific
```php
// VULNERABLE - Mass assignment
$user = User::create($request->all());

// VULNERABLE - Raw queries
DB::raw("SELECT * FROM users WHERE id = " . $id);

// SECURE
$user = User::create($request->only(['name', 'email']));
DB::select("SELECT * FROM users WHERE id = ?", [$id]);
```

---

## Ruby

### SQL Injection
```ruby
# VULNERABLE
User.where("name = '#{params[:name]}'")
User.find_by("id = #{params[:id]}")

# SECURE
User.where(name: params[:name])
User.where("name = ?", params[:name])
```

### Command Injection
```ruby
# VULNERABLE
`ls #{user_input}`
system("cat " + filename)
exec(params[:cmd])
%x(#{user_input})

# SECURE
system("ls", user_input)
Open3.capture3("cat", filename)
```

### Mass Assignment
```ruby
# VULNERABLE
User.new(params[:user])
@user.update(params[:user])

# SECURE
User.new(params.require(:user).permit(:name, :email))
```

### Deserialization
```ruby
# VULNERABLE
Marshal.load(user_data)
YAML.load(user_input)

# SECURE
YAML.safe_load(user_input)
JSON.parse(user_input)
```

---

## Java

### SQL Injection
```java
// VULNERABLE
String query = "SELECT * FROM users WHERE id = " + userId;
Statement stmt = conn.createStatement();
stmt.executeQuery(query);

// SECURE
PreparedStatement stmt = conn.prepareStatement("SELECT * FROM users WHERE id = ?");
stmt.setString(1, userId);
```

### XXE (XML External Entity)
```java
// VULNERABLE
DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();
DocumentBuilder db = dbf.newDocumentBuilder();
db.parse(userInput);

// SECURE
dbf.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
dbf.setFeature("http://xml.org/sax/features/external-general-entities", false);
```

### Deserialization
```java
// VULNERABLE
ObjectInputStream ois = new ObjectInputStream(inputStream);
Object obj = ois.readObject();

// SECURE
// Use allow-list for classes
// Or avoid Java serialization entirely
```

### SSRF
```java
// VULNERABLE
URL url = new URL(userInput);
HttpURLConnection conn = (HttpURLConnection) url.openConnection();

// SECURE
URL url = new URL(userInput);
if (!isAllowedHost(url.getHost())) {
    throw new SecurityException("Blocked host");
}
```

### Spring Specific
```java
// VULNERABLE - SpEL injection
@Value("#{${user.input}}")

// VULNERABLE - Mass assignment
@PostMapping("/user")
public User create(@RequestBody User user) { }

// SECURE
public User create(@RequestBody @Valid UserDTO dto) { }
```

---

## Rust

### SQL Injection (with raw queries)
```rust
// VULNERABLE
let query = format!("SELECT * FROM users WHERE id = {}", user_id);
conn.execute(&query, &[]).unwrap();

// SECURE
conn.execute("SELECT * FROM users WHERE id = $1", &[&user_id]).unwrap();
```

### Command Injection
```rust
// VULNERABLE
Command::new("sh").arg("-c").arg(format!("ls {}", user_input)).output();

// SECURE
Command::new("ls").arg(user_input).output();
```

### Path Traversal
```rust
// VULNERABLE
let path = format!("./files/{}", filename);
fs::read_to_string(&path)?;

// SECURE
let path = Path::new("./files").join(&filename);
if !path.starts_with("./files") {
    return Err("Invalid path");
}
```

---

## Detection Commands Summary

```bash
# SQL Injection patterns
grep -rn "SELECT.*\+\|INSERT.*\+\|UPDATE.*\+\|DELETE.*\+" --include="*.{js,ts,py,go,java,php,rb}"
grep -rn "execute.*f\"\|query.*f\"\|raw.*f\"" --include="*.py"

# Command Injection
grep -rn "exec\|system\|spawn\|popen\|shell" --include="*.{js,ts,py,go,java,php,rb}"

# Path Traversal
grep -rn "\.\.\/\|\.\.\\\\|readFile\|open\(" --include="*.{js,ts,py,go,java,php,rb}"

# Deserialization
grep -rn "pickle\|marshal\|unserialize\|yaml\.load\|readObject" --include="*.{py,php,java,rb}"

# XSS sinks
grep -rn "innerHTML\|outerHTML\|document\.write\|dangerouslySetInnerHTML" --include="*.{js,ts,jsx,tsx}"

# SSRF sources
grep -rn "fetch\|axios\|request\|http\.get\|urllib" --include="*.{js,ts,py,go}"
```
